# Creating a GitHub App to detect main branch changes

There are many alternatives and nuances to this setups. I create a github app on free tier of Github with full admin rights, using local Jenkins master.

1. Navigate to GitHub App settings:
   - Go to your GitHub profile settings (or organization settings if you want an org-owned app)
   - Select "Developer settings" at the bottom of the left sidebar
   - Click on "GitHub Apps"
   - Click "New GitHub App"

2. Configure basic App information:
   - Name: Choose a descriptive name (e.g., "Repo-Sync-Bot")
   - Description: Briefly explain its purpose (e.g., "Automation for syncing repositories")
   - Homepage URL: Your company website or Jenkins server URL
   - Callback URL: Not required for this use case, can be your Jenkins URL
        Webhook (see below for details):
            Enable webhooks
            Webhook URL: Your Jenkins webhook endpoint (e.g., https://jenkins.example.com/github-webhook/)
            Webhook secret: Generate a secure random string and save it (you'll need this in Jenkins)

3. Set permissions:
   - Under "Repository permissions":
   - Contents: Set to "Read & write" (for repository content access)
     - Metadata: Set to "Read-only"
     - Webhooks: Set to "Read & write" if you need to manage webhooks
   - Under "Organization permissions": None needed for basic repo sync
   - Under "User permissions": None needed for this use case

4. Set repository access:
   - Choose "Only on repositories that the app is installed on"

5. Webhook events:
   - Select "Push" events to trigger on code pushes

6. Create the GitHub App:
   - Click "Create GitHub App"

7. Generate a private key:
   - After creation, scroll down to the "Private keys" section
   - Click "Generate a private key"
   - A .pem file will be downloaded - store this securely
   - Note your App ID (displayed at the top of the page)

8. Install the App:
   - Click "Install App" in the left sidebar
   - Choose the account where you want to install it
   - Select the repositories you want to give it access to (or all repositories)
   - Click "Install"
   - Note the Installation ID (visible in the URL after installation)

9. Store credentials in Jenkins (see below):
   - Add the private key (.pem file) to Jenkins credentials store
     - Go to Manage Jenkins → Security → Credentials → System → Global credentials
     - Click Add Credentials
     - Select GitHub App as the kind
     - Enter your App ID
     - Copy the modified (see nuances) contents of a .pem file you downloaded
     - Give it an ID like "github-sync-app"

## Nuances
### Step 2: Jenkins security
We have chosen to use a webhook that will trigger a Jenkins synchronizing job. Configured without care, this method could expose Jenkins master to critical security threats. **Always** protect traffic and connection between the code hosting side and Jenkins masters. There are several obligatory actions to perform to secure Jenkins in production environment like securing networks with proxies, firewalls and IP lists, using mutual authorization, regular secret rotations etc.

For our laboratory purposes, we are running Jenkins master on a local machine, exposed on a local port. To allow the webhook to reach a machine, there are two classes of solutions available:
- Running secure tunnel service, allowing to tunnel a traffic to a local machine in a secure manner: [nginx](https://ngrok.com/our-product/secure-tunnels), [localtunnel](https://theboroer.github.io/localtunnel-www/), etc
- Running a webhook relay service like [Webhook Relay](https://webhookrelay.com/) that creates a public endpoint to receive webhook and it redirects it to the local machine.

I am using a Webhook relay to do the redirection:
```bash
# First, sign up on webhookrelay.com
# Create token and secret key

# Second, install CLI commands
curl -s https://webhookrelay.com/install.sh | bash

# Authenticate
relay login -k <token-key> -s <secret-key>

# Expose a local host with Jenkins to github webhooks
relay forward --bucket github-jenkins http://localhost:8080/github-webhook/
```

### Step 9: Private key of github app in Jenkins
There is [a detailed instruction](https://docs.cloudbees.com/docs/cloudbees-ci/latest/cloud-admin-guide/github-app-auth) of how to add Github App authentication to Jenkins. Among other things, please pay attention to the fact that the private key generated by Github is not compatible to the format [used by Jenkins](https://docs.cloudbees.com/docs/cloudbees-ci/latest/cloud-admin-guide/github-app-auth#_generating_a_private_key_for_authenticating_to_the_github_app). To make it work please do:
```bash
openssl pkcs8 -topk8 -inform PEM -outform PEM -in key-in-your-downloads-folder.pem -out converted-github-app.pem -nocrypt
```
In addition, please know that this Github App-Jenkins credentials cannot be used to authenticate to Github with Github integration plugins (it takes only secret text type of credentials).